name: Update Traffic Badges
on:
  schedule:
    - cron: "0 14 * * *"   # Daily 14:00 UTC
  workflow_dispatch:

jobs:
  update-traffic:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch repository traffic data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: kugendran-naidoo
          REPO: htakenote_DevOps
        run: |
          mkdir -p traffic
          curl -s -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/$OWNER/$REPO/traffic/clones \
            > traffic/clones.json
          curl -s -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/$OWNER/$REPO/traffic/views \
            > traffic/views.json

          # Sum counts over last 14 days; default to 0 if missing
          TOTAL_CLONES=$(jq -r '[.clones[].count] | add // 0' traffic/clones.json)
          TOTAL_VIEWS=$(jq -r '[.views[].count] | add // 0' traffic/views.json)

          echo "TOTAL_CLONES=$TOTAL_CLONES" >> $GITHUB_ENV
          echo "TOTAL_VIEWS=$TOTAL_VIEWS" >> $GITHUB_ENV

      - name: Upload clone badge to Gist
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}   # PAT with "gist" scope
          gistID: 2b0de4f9f92a605b780e986e6d48ffcc   # clones.json gist
          filename: clones.json
          label: "clones (14d)"
          message: ${{ env.TOTAL_CLONES }}
          color: "blue"

      - name: Upload view badge to Gist
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}   # PAT with "gist" scope
          gistID: 9b749f24de62343dc995f8d524027c39   # views.json gist
          filename: views.json
          label: "views (14d)"
          message: ${{ env.TOTAL_VIEWS }}
          color: "green"
